import httpx
from app.core.settings import settings


class OllamaCategorizer:
    def __init__(self):
        self.model_name = settings.MODEL_NAME
        self.llm_url = settings.LLM_URL

    def categorize_product(self, product_name, description, category_list):
        """Категоризирует товар используя Ollama"""
        # Формируем промпт
        prompt = f"""
Ты - эксперт по категоризации товаров. Твоя задача - присвоить товару наиболее подходящую категорию из предоставленного списка.

### Входные данные:
- **Название товара:** [название]
- **Описание товара:** [описание]
- **Доступные категории:** [список категорий]

### Правила категоризации:
1. Выбирай категорию ТОЛЬКО из предоставленного списка
2. Анализируй все данные о товаре: название, описание, характеристики
3. Если товар может подходить к нескольким категориям, выбирай наиболее специфичную
4. При сомнениях выбирай категорию, к которой товар относится в первую очередь
5. Учитывай контекст использования товара

### Формат ответа:
Отвечай ТОЛЬКО названием категории без дополнительных слов, объяснений или форматирования.

### Пример:
**Товар:** Apple iPhone 15 Pro
**Описание:** Смартфон с экраном 6.1", камерой 48МП, процессором A17 Pro
**Категории:** [Электроника, Смартфоны, Аксессуары, Компьютеры]

**Ответ:**
Смартфоны

---

## Шаблон для использования:

**Товар:** {product_name}
**Описание:** {description}
**Доступные категории:** {category_list}

Определи наиболее подходящую категорию согласно инструкции выше."""

        # Отправляем запрос в Ollama
        payload = {
            "model": self.model_name,
            "prompt": prompt,
            "stream": False,
            "options": {
                "temperature": 0.1,  # Низкая температура для стабильных ответов
                "top_p": 0.9,
                "top_k": 10
            }
        }

        response = httpx.post(self.llm_url, json=payload, timeout=60)
        response.raise_for_status()

        # Парсим ответ
        result = response.json()
        raw_answer = result.get('response', '').strip()

        return raw_answer
